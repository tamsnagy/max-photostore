<!DOCTYPE html>
<html>

<head>
    <!-- JQuery import -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
    <script src="js/scripts.js"></script>
    <script src="js/home.js"></script>
    <script>
        var currentGroup;
    </script>
    <link rel="stylesheet" type="text/css" href="css/style.css">
</head>

<script>
    function refreshGroups() {
        $.ajax({
            url: "/api/group/",
            type: "GET",
            cache: "false",
            contentType: "application/json",
            success: function(xhr, status, error) {
                $("#groups-list").html("");
                $.each(xhr.data, function(i, item) {
                    $("#groups-list").append($("<div id='group"+item.id+"' class='groups-list-item'>"+item.name+"</div>"));
                });
            }
        });
    }

    function deleteGroup(id) {
        $.ajax({
            url: "/api/group/" + id,
            type: "DELETE",
            cache: "false",
            contentType: "application/json",
            beforeSend: function() {
                $("#delete-group-button").prop("disabled", true);
            },
            success: function() {
                listGroups();
            },
            error: function(xhr, status, error) {
                alert(xhr.responseText);
            },
            complete: function() {
                $("#delete-group-button").prop("disabled", false);
            }
        });
    }

    $(document).ready(function() {
        refreshGroups();

        $("#group-details-div").on("click", "#remove-member-button", function() {
            var selectedOption = $("#group-details-members option:selected");
            var memberId = selectedOption.val();
            if (memberId === undefined)
                return;
            $.ajax({
                url: "/api/group/"+currentGroup+"/removemember",
                type: "POST",
                data: JSON.stringify({"id":+memberId}),
                cache: "false",
                contentType: "application/json",
                success: function(xhr, status, error) {
                    selectedOption.remove();
                },
                error: function(xhr, status, error) {
                    alert(xhr.responseText);
                }
            });
        });

        $("#groups-list").on("click", ".groups-list-item", function() {
            $.ajax({
                url: "/api/group/"+parseInt(this.id.substring(5)),
                type: "GET",
                cache: "false",
                contentType: "application/json",
                success: function(xhr, status, error) {
                    var groupDetailsDiv = $("#group-details-div");
                    var group = xhr.data;

                    var str = "";
                    str += "<div class='group-details-header'>"+group.name+"</div>";
                    str += "Owner: " + group.owner.username + " ("+group.owner.email+")<br/>";
                    str += "Members<br />";
                    str += "<select id='group-details-members' size=10 style='width: 100%;'>";
                    $.each(group.members, function(i, item) {
                        str += "<option value='"+item.id+"'>"+item.username+"</option>";
                    });
                    str += "</select><br />";
                    str += "<button id='remove-member-button'>Remove member</button><br />";
                    str += "Albums<br />";
                    str += "<select id='group-details-albums' size=10 style='width: 100%;'>";
                    $.each(group.albums, function(i, item) {
                        str += "<option value='"+item.id+"'>"+item.name+"</option>";
                    });
                    str += "</select><br />";
                    str += "<button id='delete-group-button' onclick='deleteGroup("+group.id+")'>Delete group</button>";
                    groupDetailsDiv.html(str);

                    currentGroup = group.id;

                    $("#groups-div").hide();
                    groupDetailsDiv.show();
                }
            });
        });

        $("#create-group-button").on("click", function() {
            $.ajax({
                url: "/api/group/",
                type: "PUT",
                data: JSON.stringify($("#create-group-form").serializeObject()),
                cache: "false",
                contentType: "application/json",
                beforeSend: function() {
                    $("#create-group-button").prop("disabled", true);
                },
                success: function() {
                    refreshGroups();
                },
                error: function(xhr, status, error) {
                    alert(xhr.responseText);
                },
                complete: function() {
                    $("#create-group-button").prop("disabled", false);
                }
            });
        });

        $("#log-out-link").on("click", function() {
            $.ajax({
                url: "/api/user/logout",
                type: "POST",
                cache: "false",
                contentType: "application/json",
                beforeSend: function() {
                    $("#log-out-link").prop("disabled", true);
                },
                success: function() {
                    window.location.replace("index.html");
                }
            });
        });
    });


    $(document).ready(listAlbums());
</script>

<body>

<a id="log-out-link" href="javascript:;">Log out</a><br />
<a href="groups.html">Groups</a><br />

<br/>
<br/>

<p id="current-album-display-tag"></p>

<div class="container">
    <div class="left">
        <form id="create-album">
            <label>Album name</label>
            <input id="create-album-name" type="text" name="name">
            <input type="button" value="Create Album" onclick="createAlbum()">
        </form><br />

        <button onclick="listAlbums()" id="list-albums-button">Albums</button><br />
        <button onclick="listGroups()" id="list-groups-button">Groups</button>
    </div>

    <div class="right">
        <!-- Upload file form -->
        <form id="upload-file-form">
            <label for="upload-file-input">Upload your file:</label>
            <input id="upload-file-input" type="file" name="uploadfile" accept="*"/>
            <input type="button" value="Upload" onclick="uploadPicture()">
            <br />
            <span id="upload-file-message"></span>
        </form>
        <br />
        <hr />

        <div id="albums-div">
            <table id="albums-table"></table>
        </div>

        <div id="album-view">
            <div id="go-back-to-album"></div>
            <table id="albums-in-album"></table>
            <table id="pictures-in-album"></table>
        </div>

        <div id="groups-div">
            <div class="groups-header">My groups</div>
            <div id="groups-list"></div>
            <div class="groups-footer">
                <form id="create-group-form">
                    Name <input name="name" type="text"><input id="create-group-button" type="button" value="Create group" />
                </form>
            </div>
        </div>

        <div id="group-details-div"></div>
    </div>
</div>

</body>

</html>